name: Create Develop Branches

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'List of repositories (comma-separated, e.g., "repo1,repo2,repo3")'
        required: true
        type: string
      organization:
        description: 'GitHub organization name'
        required: true
        default: 'vishnu-parandhaman'
        type: string

jobs:
  create-develop-branches:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      
      - name: Configure git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
      
      - name: Create develop branches
        env:
          TOKEN: ${{ secrets.PAT_TOKEN }}
          ORGANIZATION: ${{ github.event.inputs.organization }}
        run: |
          # Define color codes for logging
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[0;33m'
          BLUE='\033[0;34m'
          PURPLE='\033[0;35m'
          NC='\033[0m' # No Color
          
          # Initialize counters for summary
          TOTAL=0
          SUCCESS=0
          ALREADY_EXISTS=0
          NOT_FOUND=0
          EMPTY=0
          OTHER_ISSUES=0
          
          # Convert comma-separated list to array
          IFS=',' read -ra REPOS <<< "${{ github.event.inputs.repositories }}"
          
          echo -e "${BLUE}‚ÑπÔ∏è Starting processing of ${#REPOS[@]} repositories${NC}"
          
          # Loop through each repository
          for REPO in "${REPOS[@]}"; do
            REPO=$(echo $REPO | xargs) # Trim whitespace
            TOTAL=$((TOTAL+1))
            
            echo -e "\n${PURPLE}üîÑ PROCESSING: $ORGANIZATION/$REPO${NC}"
            
            # Check if repository exists using curl directly
            echo -e "${BLUE}‚ÑπÔ∏è Checking if repository exists...${NC}"
            REPO_INFO=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$ORGANIZATION/$REPO")
            
            if echo "$REPO_INFO" | grep -q "Not Found"; then
              echo -e "${RED}‚ùå NOT FOUND: $ORGANIZATION/$REPO${NC}"
              NOT_FOUND=$((NOT_FOUND+1))
              continue
            fi
            
            echo -e "${BLUE}‚ÑπÔ∏è Repository found: $ORGANIZATION/$REPO${NC}"
            
            # Check if develop branch already exists using API
            BRANCHES=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$ORGANIZATION/$REPO/branches")
            
            if echo "$BRANCHES" | grep -q '"name": "develop"'; then
              echo -e "${YELLOW}‚ö†Ô∏è SKIPPED ('develop' branch exists): $ORGANIZATION/$REPO${NC}"
              ALREADY_EXISTS=$((ALREADY_EXISTS+1))
              continue
            fi
            
            # Create a temporary directory for cloning
            TEMP_DIR=$(mktemp -d)
            cd $TEMP_DIR
            
            # Extract default branch
            DEFAULT_BRANCH=$(echo "$REPO_INFO" | grep '"default_branch"' | cut -d'"' -f4)
            if [ -z "$DEFAULT_BRANCH" ]; then
              DEFAULT_BRANCH="main" # fallback to main if we can't determine
            fi
            
            echo -e "${BLUE}‚ÑπÔ∏è Default branch: $DEFAULT_BRANCH${NC}"
            
            # Check if repository is empty
            COMMITS=$(curl -s -H "Authorization: token $TOKEN" \
              "https://api.github.com/repos/$ORGANIZATION/$REPO/commits?sha=$DEFAULT_BRANCH")
            
            if echo "$COMMITS" | grep -q "\"Not Found\""; then
              echo -e "${BLUE}‚ÑπÔ∏è EMPTY REPOSITORY: $ORGANIZATION/$REPO${NC}"
              echo -e "${BLUE}‚ÑπÔ∏è Creating initial commit and branches...${NC}"
              
              # Initialize the repo with README
              echo -e "# $REPO\n\nInitial repository setup by GitHub Actions." > README.md
              git init
              git add README.md
              git commit -m "Initial commit"
              
              # Create main branch and push
              git branch -M main
              git remote add origin "https://$TOKEN@github.com/$ORGANIZATION/$REPO.git"
              
              echo -e "${BLUE}‚ÑπÔ∏è Pushing initial commit to main branch...${NC}"
              if ! git push -u origin main; then
                echo -e "${RED}‚ùå PUSH FAILED: $ORGANIZATION/$REPO - Could not push to main branch${NC}"
                OTHER_ISSUES=$((OTHER_ISSUES+1))
                cd ..
                rm -rf $TEMP_DIR
                continue
              fi
              
              # Create and push develop branch
              git checkout -b develop
              echo -e "${BLUE}‚ÑπÔ∏è Pushing develop branch...${NC}"
              if ! git push -u origin develop; then
                echo -e "${RED}‚ùå PUSH FAILED: $ORGANIZATION/$REPO - Could not push develop branch${NC}"
                OTHER_ISSUES=$((OTHER_ISSUES+1))
                cd ..
                rm -rf $TEMP_DIR
                continue
              fi
              
              echo -e "${GREEN}‚úÖ SUCCESS (created both 'main' and 'develop' branches): $ORGANIZATION/$REPO${NC}"
              SUCCESS=$((SUCCESS+1))
              EMPTY=$((EMPTY+1))
              
            else
              # Repository has commits, clone it
              echo -e "${BLUE}‚ÑπÔ∏è Cloning repository...${NC}"
              git clone "https://$TOKEN@github.com/$ORGANIZATION/$REPO.git" .
              
              if [ $? -ne 0 ]; then
                echo -e "${RED}‚ùå CLONE FAILED: $ORGANIZATION/$REPO - This could be due to permissions or network issues${NC}"
                OTHER_ISSUES=$((OTHER_ISSUES+1))
                cd ..
                rm -rf $TEMP_DIR
                continue
              fi
              
              # Create develop branch from default branch
              echo -e "${BLUE}‚ÑπÔ∏è Creating 'develop' branch from '$DEFAULT_BRANCH'...${NC}"
              
              # Try 3 times in case of network issues
              MAX_RETRIES=3
              SUCCESS_CREATE=false
              
              for i in $(seq 1 $MAX_RETRIES); do
                if git checkout $DEFAULT_BRANCH && \
                   git checkout -b develop && \
                   git push -u origin develop; then
                  SUCCESS_CREATE=true
                  break
                fi
                
                if [ $i -lt $MAX_RETRIES ]; then
                  echo -e "${YELLOW}‚ö†Ô∏è Retry $i/$MAX_RETRIES - Failed to create branch, trying again...${NC}"
                  sleep 2
                fi
              done
              
              if [ "$SUCCESS_CREATE" = true ]; then
                echo -e "${GREEN}‚úÖ SUCCESS (created 'develop' branch): $ORGANIZATION/$REPO${NC}"
                SUCCESS=$((SUCCESS+1))
              else
                echo -e "${RED}‚ùå FAILED: $ORGANIZATION/$REPO - Could not create 'develop' branch after $MAX_RETRIES attempts${NC}"
                OTHER_ISSUES=$((OTHER_ISSUES+1))
              fi
            fi
            
            # Clean up
            cd ..
            rm -rf $TEMP_DIR
          done
          
          # Print summary
          echo -e "\n${BLUE}‚ÑπÔ∏è SUMMARY${NC}"
          echo -e "${BLUE}‚ÑπÔ∏è Total repositories processed: $TOTAL${NC}"
          echo -e "${GREEN}‚úÖ Successfully created 'develop' branch: $SUCCESS${NC}"
          echo -e "${YELLOW}‚ö†Ô∏è Repositories with existing 'develop' branch: $ALREADY_EXISTS${NC}"
          echo -e "${BLUE}‚ÑπÔ∏è Empty repositories initialized: $EMPTY${NC}"
          echo -e "${RED}‚ùå Repositories not found: $NOT_FOUND${NC}"
          echo -e "${RED}‚ùå Repositories with other issues: $OTHER_ISSUES${NC}"